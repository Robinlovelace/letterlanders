name: Android Build

on:
  workflow_dispatch: {}
  push:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  android-build:
    name: Build Android APKs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          # Optimized for CI - only aarch64 + wasm32 for wasm-pack
          targets: aarch64-linux-android,wasm32-unknown-unknown

      - name: Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          shared-key: android-rust-cache
          # Include root target/ for Android builds and workspace crates
          workspaces: |
            . -> target
            app/src-tauri -> target
            core -> target
            wasm -> target
          cache-on-failure: true

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev build-essential curl wget file libssl-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev libasound2-dev espeak

      - name: Install wasm-pack
        run: cargo install wasm-pack

      - name: Build WASM module
        run: |
          cd wasm
          wasm-pack build --target web --out-dir ../app/src/lib/wasm-pkg

      - name: Install Frontend Dependencies
        working-directory: app
        run: npm install

      - name: Download Sound Assets
        working-directory: app
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p static/sounds/prompts
          gh release download --pattern "*.wav" --dir static/sounds/prompts

      - name: Initialize Android Project
        working-directory: app
        run: npm run tauri android init

      - name: Ensure Gradle settings file
        working-directory: app/src-tauri/gen/android
        run: |
          if [ ! -f tauri.settings.gradle ]; then
            printf "%s\n" \
              'include(":app")' \
              'project(":app").projectDir = file("app")' \
              > tauri.settings.gradle
          fi

      - name: Setup Android Signing
        run: |
          if [ -z "$ANDROID_KEYSTORE" ]; then
            echo "No ANDROID_KEYSTORE secret set; skipping signing."
            exit 0
          fi
          
          # Restore keystore from base64-encoded secret
          echo "$ANDROID_KEYSTORE" | base64 -di > app/src-tauri/gen/android/app/release-keystore.jks
          chmod 600 app/src-tauri/gen/android/app/release-keystore.jks
          
          # Create keystore.properties (no leading whitespace)
          cat > app/src-tauri/gen/android/keystore.properties << EOF
          storeFile=release-keystore.jks
          storePassword=${ANDROID_KEYSTORE_PASSWORD}
          keyAlias=${ANDROID_KEY_ALIAS}
          password=${ANDROID_KEY_PASSWORD}
          EOF
          # Remove leading whitespace from properties file
          sed -i 's/^[[:space:]]*//' app/src-tauri/gen/android/keystore.properties
          
          # Patch build.gradle.kts to add signing configuration
          BUILD_GRADLE="app/src-tauri/gen/android/app/build.gradle.kts"
          
          # Add FileInputStream import (Properties is already imported by Tauri)
          sed -i '/^import java.util.Properties/a import java.io.FileInputStream' "$BUILD_GRADLE"
          
          # Create signing config snippet
          # Since Properties is already imported, we can use short form
          # Use explicit lambda parameter to avoid 'it' scope issues
          printf '%s\n' \
            'signingConfigs {' \
            '    create("release") {' \
            '        val keystorePropertiesFile = rootProject.file("keystore.properties")' \
            '        val keystoreProperties = Properties()' \
            '        if (keystorePropertiesFile.exists()) {' \
            '            keystoreProperties.load(FileInputStream(keystorePropertiesFile))' \
            '        }' \
            '        keyAlias = keystoreProperties["keyAlias"] as? String' \
            '        keyPassword = keystoreProperties["password"] as? String' \
            '        storeFile = (keystoreProperties["storeFile"] as? String)?.let { storePath -> file(storePath) }' \
            '        storePassword = keystoreProperties["storePassword"] as? String' \
            '    }' \
            '}' > /tmp/signing_config.txt
          
          # Insert signing config before buildTypes using awk
          awk '/buildTypes \{/{while(getline line < "/tmp/signing_config.txt"){print "    " line}} 1' "$BUILD_GRADLE" > "$BUILD_GRADLE.tmp" && mv "$BUILD_GRADLE.tmp" "$BUILD_GRADLE"
          
          # Update release buildType to use signing config
          sed -i 's/getByName("release") {/getByName("release") {\n            signingConfig = signingConfigs.getByName("release")/' "$BUILD_GRADLE"
          
          echo "Signing configuration applied to build.gradle.kts"
          cat "$BUILD_GRADLE" | head -60
        env:
          ANDROID_KEYSTORE: ${{ secrets.ANDROID_KEYSTORE }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Build Release APK
        working-directory: app
        run: npm run tauri android build -- --apk true --target aarch64

      - name: List APKs
        working-directory: app/src-tauri/gen/android/app/build/outputs/apk
        run: |
          echo "APKs found:"
          find . -name "*.apk" -exec ls -la {} \;

      - name: Upload APK Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: letterlanders-android-apks
          path: app/src-tauri/gen/android/app/build/outputs/apk/**/*.apk

      - name: Upload APKs to Latest Release
        if: github.ref == 'refs/heads/main'
        working-directory: app/src-tauri/gen/android/app/build/outputs/apk
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME=$(gh release list --limit 1 --json tagName --jq '.[0].tagName')
          
          # Upload all APKs found
          for apk in $(find . -name "*.apk"); do
            echo "Uploading $apk to release $TAG_NAME..."
            gh release upload --clobber "$TAG_NAME" "$apk" || echo "Failed to upload $apk"
          done
