name: Android Build

on:
  workflow_dispatch: {}
  push:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  android-build:
    name: Build Android APKs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          # Optimized for CI - only aarch64 + wasm32 for wasm-pack
          targets: aarch64-linux-android,wasm32-unknown-unknown

      - name: Rust Cache
        uses: swatinem/rust-cache@v2
        with:
          shared-key: android-rust-cache
          workspaces: |
            app/src-tauri
            core
            wasm

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev build-essential curl wget file libssl-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev libasound2-dev espeak

      - name: Install wasm-pack
        run: cargo install wasm-pack

      - name: Build WASM module
        run: |
          cd wasm
          wasm-pack build --target web --out-dir ../app/src/lib/wasm-pkg

      - name: Install Frontend Dependencies
        working-directory: app
        run: npm install

      - name: Download Sound Assets
        working-directory: app
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p static/sounds/prompts
          gh release download --pattern "*.wav" --dir static/sounds/prompts

      - name: Initialize Android Project
        working-directory: app
        run: npm run tauri android init

      - name: Ensure Gradle settings file
        working-directory: app/src-tauri/gen/android
        run: |
          if [ ! -f tauri.settings.gradle ]; then
            printf "%s\n" \
              'include(":app")' \
              'project(":app").projectDir = file("app")' \
              > tauri.settings.gradle
          fi

      - name: Setup Android Signing
        if: ${{ secrets.ANDROID_KEYSTORE != '' }}
        run: |
          # Restore keystore from base64-encoded secret
          echo "$ANDROID_KEYSTORE" | base64 -di > app/src-tauri/gen/android/app/release-keystore.jks
          chmod 600 app/src-tauri/gen/android/app/release-keystore.jks
          
          # Create keystore.properties
          cat > app/src-tauri/gen/android/keystore.properties << EOF
          storeFile=release-keystore.jks
          storePassword=$ANDROID_KEYSTORE_PASSWORD
          keyAlias=$ANDROID_KEY_ALIAS
          password=$ANDROID_KEY_PASSWORD
          EOF
          
          # Patch build.gradle.kts to add signing configuration
          BUILD_GRADLE="app/src-tauri/gen/android/app/build.gradle.kts"
          
          # Add import at beginning of file
          sed -i '1i import java.io.FileInputStream' "$BUILD_GRADLE"
          
          # Add signing config before buildTypes block
          SIGNING_CONFIG='
signingConfigs {
    create("release") {
        val keystorePropertiesFile = rootProject.file("keystore.properties")
        val keystoreProperties = java.util.Properties()
        if (keystorePropertiesFile.exists()) {
            keystoreProperties.load(FileInputStream(keystorePropertiesFile))
        }
        keyAlias = keystoreProperties["keyAlias"] as String?
        keyPassword = keystoreProperties["password"] as String?
        storeFile = if (keystoreProperties["storeFile"] != null) file(keystoreProperties["storeFile"] as String) else null
        storePassword = keystoreProperties["storePassword"] as String?
    }
}
'
          # Insert signing config before buildTypes
          sed -i "/buildTypes {/i\\$SIGNING_CONFIG" "$BUILD_GRADLE"
          
          # Update release buildType to use signing config
          sed -i 's/getByName("release") {/getByName("release") {\n            signingConfig = signingConfigs.getByName("release")/' "$BUILD_GRADLE"
          
          echo "Signing configuration applied to build.gradle.kts"
        env:
          ANDROID_KEYSTORE: ${{ secrets.ANDROID_KEYSTORE }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Build Release APK
        working-directory: app
        run: npm run tauri android build -- --apk true --target aarch64

      - name: List APKs
        working-directory: app/src-tauri/gen/android/app/build/outputs/apk
        run: |
          echo "APKs found:"
          find . -name "*.apk" -exec ls -la {} \;

      - name: Upload APK Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: letterlanders-android-apks
          path: app/src-tauri/gen/android/app/build/outputs/apk/**/*.apk

      - name: Upload APKs to Latest Release
        if: github.ref == 'refs/heads/main'
        working-directory: app/src-tauri/gen/android/app/build/outputs/apk
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME=$(gh release list --limit 1 --json tagName --jq '.[0].tagName')
          
          # Upload all APKs found
          for apk in $(find . -name "*.apk"); do
            echo "Uploading $apk to release $TAG_NAME..."
            gh release upload --clobber "$TAG_NAME" "$apk" || echo "Failed to upload $apk"
          done
