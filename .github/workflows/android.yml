name: Android Build

on:
  workflow_dispatch: {}
  push:
    branches: [ "main" ]

jobs:
  debug-apk:
    name: Build Debug APK (unsigned)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,i686-linux-android,x86_64-linux-android

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev build-essential curl wget file libssl-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev libasound2-dev espeak

      - name: Install wasm-pack
        run: cargo install wasm-pack

      - name: Build WASM module
        run: |
          cd wasm
          wasm-pack build --target web --out-dir ../app/src/lib/wasm-pkg

      - name: Install Frontend Dependencies
        working-directory: app
        run: npm install

      - name: Download Sound Assets
        working-directory: app
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p static/sounds/prompts
          gh release download --pattern "*.wav" --dir static/sounds/prompts

      - name: Initialize Android Project
        working-directory: app
        run: npm run tauri android init

      - name: Ensure Gradle settings file
        working-directory: app/src-tauri/gen/android
        run: |
          if [ ! -f tauri.settings.gradle ]; then
            printf "%s\n" \
              'include(":app")' \
              'project(":app").projectDir = file("app")' \
              > tauri.settings.gradle
          fi

      - name: Build Android APK (debug)
        working-directory: app
        run: npm run tauri android build

      - name: Upload Debug APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: letterlanders-android-apk-debug
          path: app/src-tauri/gen/android/app/build/outputs/apk/**/*.apk

  release-aab:
    name: Build Release AAB (signed)
    runs-on: ubuntu-latest
    needs: debug-apk
    if: ${{ github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/') }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          # targets: aarch64-linux-android,armv7-linux-androideabi,i686-linux-android,x86_64-linux-android
          # Only building for modern Android devices (aarch64) to speed up CI.
          # Uncomment the line above and remove the one below to support older devices and emulators.
          targets: aarch64-linux-android

      - name: Rust Cache
        uses: swatinem/rust-cache@v2
        with:
           workspaces: |
             app/src-tauri
             core
             wasm

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev build-essential curl wget file libssl-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev libasound2-dev espeak

      - name: Install wasm-pack
        run: cargo install wasm-pack

      - name: Build WASM module
        run: |
          cd wasm
          wasm-pack build --target web --out-dir ../app/src/lib/wasm-pkg

      - name: Install Frontend Dependencies
        working-directory: app
        run: npm install

      - name: Download Sound Assets
        working-directory: app
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p static/sounds/prompts
          gh release download --pattern "*.wav" --dir static/sounds/prompts

      - name: Initialize Android Project
        working-directory: app
        run: npm run tauri android init

      - name: Ensure Gradle settings file
        working-directory: app/src-tauri/gen/android
        run: |
          if [ ! -f tauri.settings.gradle ]; then
            printf "%s\n" \
              'include(":app")' \
              'project(":app").projectDir = file("app")' \
              > tauri.settings.gradle
          fi

      - name: Restore Android keystore from secrets
        run: |
          if [ -z "$ANDROID_KEYSTORE" ]; then
            echo "No ANDROID_KEYSTORE secret set; skipping signing.";
            exit 0;
          fi
          mkdir -p app/src-tauri/gen/android/app
          if ! echo "$ANDROID_KEYSTORE" | base64 -di > app/src-tauri/gen/android/app/release-keystore.jks; then
            echo "ANDROID_KEYSTORE is not valid base64. Re-create it with: base64 -w0 release-keystore.jks";
            exit 1;
          fi
          chmod 600 app/src-tauri/gen/android/app/release-keystore.jks
        env:
          ANDROID_KEYSTORE: ${{ secrets.ANDROID_KEYSTORE }}

      - name: Create keystore.properties
        run: |
          if [ -z "$ANDROID_KEYSTORE" ]; then
            echo "No ANDROID_KEYSTORE secret set; skipping signing config.";
            exit 0;
          fi
          printf '%s\n' \
            "storeFile=release-keystore.jks" \
            "storePassword=$ANDROID_KEYSTORE_PASSWORD" \
            "keyAlias=$ANDROID_KEY_ALIAS" \
            "keyPassword=$ANDROID_KEY_PASSWORD" \
            > app/src-tauri/gen/android/keystore.properties
          # Copy to app module directory as well to be safe
          cp app/src-tauri/gen/android/keystore.properties app/src-tauri/gen/android/app/keystore.properties
        env:
          ANDROID_KEYSTORE: ${{ secrets.ANDROID_KEYSTORE }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Build Release APK (signed)
        working-directory: app
        env:
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ""
        run: npm run tauri android build -- --apk true --target aarch64

      - name: Rename Signed APK
        working-directory: app/src-tauri/gen/android/app/build/outputs/apk
        run: |
          find . -name "*-release.apk" -exec mv {} {}-signed.apk \; || true
          find . -name "*-universal-release.apk" -exec mv {} {}-signed.apk \; || true

      - name: Upload Release Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-release-apks
          path: app/src-tauri/gen/android/app/build/outputs/apk/**/*.apk

      - name: Upload APKs to Latest Release
        working-directory: app/src-tauri/gen/android/app/build/outputs/apk
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Upload both signed and unsigned
          SIGNED_APK=$(find . -name "*signed.apk" | head -n 1)
          UNSIGNED_APK=$(find . -name "*-unsigned.apk" | head -n 1)
          
          TAG_NAME=$(gh release list --limit 1 --json tagName --jq '.[0].tagName')
          
          if [ -f "$SIGNED_APK" ]; then
             echo "Uploading Signed APK: $SIGNED_APK"
             gh release upload --clobber "$TAG_NAME" "$SIGNED_APK"
          else
             echo "WARNING: No signed APK found."
          fi
          
          if [ -f "$UNSIGNED_APK" ]; then
             echo "Uploading Unsigned APK: $UNSIGNED_APK"
             gh release upload --clobber "$TAG_NAME" "$UNSIGNED_APK"
          else
              echo "No unsigned APK found."
          fi

      # Optional: Deploy to Google Play (internal track)
      # - name: Deploy to Google Play
      #   uses: r0adkll/upload-google-play@v1
      #   with:
      #     serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
      #     packageName: com.example.yourapp  # <-- set your app id
      #     releaseFiles: app/src-tauri/gen/android/app/build/outputs/bundle/release/*.aab
